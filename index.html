<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>FreQ-Trad</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: #e8e5f0;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, #282fc4 0%, #121464, #04052a);
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            border-radius: 0 30px 30px 0;
            box-shadow: 0 10px 30px rgba(91, 95, 207, 0.3);
        }

        .logo {
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo::before {
            content: "≡";
            font-size: 24px;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .profile-img {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .profile-img img {

            width: 50px;
            height: 46px;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-info {
            color: white;
        }

        .profile-name {
            font-weight: 600;
            font-size: 14px;
        }

        .profile-loc {
            font-size: 12px;
            opacity: 0.8;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-item {
            color: white;
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            opacity: 0.9;
        }

        .nav-subsection {
            margin-left: 30px;
            display: none;
        }

        .nav-subsection.show {
            display: block;
        }

        .nav-subsection .nav-item {
            font-size: 14px;
            padding: 8px 12px;
        }

        .expandable::after {
            content: "▼";
            position: absolute;
            right: 15px;
            font-size: 12px;
            transition: transform 0.3s;
        }

        .expandable.expanded::after {
            transform: rotate(180deg);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }

        /* Chart Card */
        .chart-card {
            grid-column: span 2;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-filters {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 6px 15px;
            border: none;
            background: #f0f2f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #5b5fcf;
            color: white;
        }

        .chart-container {
            height: 300px;
            position: relative;
            overflow: hidden;
        }

        /* Canvas-based chart */
        #main-chart {
            width: 100%;
            height: 100%;
            display: block;
        }

        .chart-status {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 12px;
            color: #667;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 8px;
            border-radius: 6px;
        }

        @keyframes drawLine {
            from {
                stroke-dasharray: 1000;
                stroke-dashoffset: 1000;
            }

            to {
                stroke-dashoffset: 0;
            }
        }

        /* Earnings Card */
        .earnings-card {
            background: linear-gradient(135deg, #121ad1 0%, #0e1287, #090a47);
            color: white;
        }

        .earnings-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .earnings-amount {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 15px;
            animation: countUp 1s ease-out;
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .earnings-note {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .fetch-btn {
            background: white;
            color: #5b5fcf;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .fetch-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        /* Bot Control */
        .bot-control {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }

        .bot-switch {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 8px solid #e0e0e0;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .bot-switch.active {
            border-color: #4caf50;
            color: #4caf50;
            animation: pulse 2s infinite;
        }

        .bot-switch.stop {
            border-color: #ff5252;
            color: #ff5252;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(76, 175, 80, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        /* Trades Table */
        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th {
            text-align: left;
            padding: 12px;
            color: #666;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 2px solid #f0f2f5;
        }

        .trades-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #f0f2f5;
        }

        .trades-table tr:hover {
            background: #f8f9fa;
        }

        .trade-pair {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .trade-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .trade-icon.icon {
            background: #5b5fcf;
        }

        .trade-icon.photo {
            background: #ff6b6b;
        }

        .trade-icon.illustration {
            background: #ffd700;
        }

        /* Circle Progress */
        .circle-progress-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 20px auto;
        }

        .circle-progress {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .circle-progress svg {
            width: 100%;
            height: 100%;
        }

        .circle-bg {
            fill: none;
            stroke: #f0f2f5;
            stroke-width: 15;
        }

        .circle-progress-bar {
            fill: none;
            stroke-width: 15;
            stroke-linecap: butt;
            animation: progressAnimation 2s ease-out;
        }

        @keyframes progressAnimation {
            from {
                stroke-dashoffset: 565;
            }
        }

        .circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .circle-number {
            font-size: 48px;
            font-weight: 700;
            color: #2c3e50;
        }

        .circle-label {
            font-size: 14px;
            color: #666;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-text {
            font-size: 14px;
            color: #666;
        }

        .legend-value {
            font-weight: 600;
            margin-left: 5px;
        }

        /* Control Buttons */
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .control-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn.primary {
            background: #5b5fcf;
            color: white;
        }

        .control-btn.danger {
            background: #ff5252;
            color: white;
        }

        .control-btn.warning {
            background: #ffa726;
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Logs Section */
        .logs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .log-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .log-card:hover {
            transform: scale(1.05);
        }

        .log-card h3 {
            margin-bottom: 10px;
        }

        .log-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Strategy Dropdown */
        .strategy-item {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .strategy-header {
            padding: 15px 20px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .strategy-header:hover {
            background: #e9ecef;
        }

        .strategy-details {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s;
        }

        .strategy-details.open {
            max-height: 500px;
            padding: 20px;
        }

        /* Bottom Navigation for Mobile */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 2px 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 100%;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2px 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            min-width: 60px;
            text-decoration: none;
            color: #666;
        }

        .bottom-nav-item:hover {
            background: rgba(91, 95, 207, 0.1);
            color: #5b5fcf;
        }

        .bottom-nav-item.active {
            color: #5b5fcf;
            background: rgba(91, 95, 207, 0.1);
        }

        .bottom-nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .bottom-nav-label {
            font-size: 10px;
            font-weight: 600;
            text-align: center;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            
            .chart-card {
                grid-column: span 1;
            }
            
            .main-content {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .bottom-nav {
                display: block;
            }

            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 20px 15px 80px 15px;
                width: 100%;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .page-title {
                font-size: 24px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .chart-card {
                grid-column: span 1;
            }

            .card {
                margin: 5px;
                padding: 20px;
            }

            /* Mobile-friendly tables */
            .trades-table {
                font-size: 12px;
                min-width: 100%;
                overflow-x: auto;
                display: block;
                white-space: nowrap;
            }

            .trades-table thead,
            .trades-table tbody,
            .trades-table tr {
                display: block;
            }

            .trades-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .trades-table tr {
                border: 1px solid #f0f2f5;
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 8px;
                background: white;
            }

            .trades-table td {
                border: none;
                position: relative;
                padding: 8px 8px 8px 35%;
                display: block;
                text-align: right;
            }

            .trades-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 8px;
                width: 30%;
                text-align: left;
                font-weight: 600;
                color: #666;
                font-size: 11px;
                text-transform: uppercase;
            }

            /* Chart responsive */
            .chart-container {
                height: 250px;
            }

            /* Control buttons responsive */
            .control-buttons {
                grid-template-columns: 1fr;
            }

            /* Bot control grid responsive */
            .card[style*="grid-template-columns"] {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 12px;
                padding: 16px;
            }

            /* Profit cards responsive */
            .profit-amount {
                font-size: 28px;
            }

            .earnings-amount {
                font-size: 32px;
            }

            /* Logs grid responsive */
            .logs-grid {
                grid-template-columns: 1fr;
            }

            /* Circle progress responsive */
            .circle-progress-container {
                width: 160px;
                height: 160px;
                margin: 15px auto;
            }

            .circle-progress {
                width: 160px;
                height: 160px;
            }

            .circle-progress svg {
                width: 100%;
                height: 100%;
            }

            .circle-number {
                font-size: 32px;
            }

            .circle-label {
                font-size: 12px;
            }

            /* Legend responsive */
            .legend {
                flex-direction: row;
                align-items: center;
                gap: 8px;
            }

            /* Metrics grid responsive */
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            /* Config summary responsive */
            .config-summary {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 15px 10px 80px 10px;
            }

            .bottom-nav-label {
                font-size: 9px;
            }

            .bottom-nav-icon {
                font-size: 18px;
            }

            .page-title {
                font-size: 20px;
            }

            .card {
                margin: 3px;
                padding: 15px;
            }

            .profit-amount {
                font-size: 24px;
            }

            .earnings-amount {
                font-size: 28px;
            }

            .chart-container {
                height: 200px;
            }

            .circle-progress-container {
                width: 140px;
                height: 140px;
                margin: 10px auto;
            }

            .circle-progress {
                width: 140px;
                height: 140px;
            }

            .circle-progress svg {
                width: 100%;
                height: 100%;
            }

            .circle-number {
                font-size: 24px;
            }

            .circle-label {
                font-size: 11px;
            }

            .currency-toggle {
                padding: 6px 15px;
                font-size: 14px;
            }

            .filter-btn {
                padding: 4px 10px;
                font-size: 12px;
            }

            /* Touch-friendly buttons */
            .control-btn,
            .fetch-btn {
                padding: 15px 20px;
                font-size: 14px;
                min-height: 44px;
            }

            .nav-item {
                padding: 15px;
                font-size: 14px;
            }

            /* Mobile table improvements */
            .trades-table td {
                padding: 10px 10px 10px 40%;
            }

            .trades-table td:before {
                width: 35%;
            }
        }

        /* Landscape mobile adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-content {
                padding: 60px 15px 15px 15px;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-container {
                height: 220px;
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .card {
            animation: slideIn 0.5s ease-out;
        }

        /* Hide sections initially */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Added for Daily Profit interactions */
        .clickable {
            cursor: pointer;
        }

        .profit-amount {
            font-size: 32px;
            font-weight: bold;
            color: #4caf50;
            margin: 20px 0;
        }

        .muted {
            color: #666;
        }

        .status-message {
            margin-top: 8px;
            font-size: 13px;
        }

        .status-message.success {
            color: #2e7d32;
        }

        .status-message.error {
            color: #c62828;
        }

        .daily-list {
            margin-top: 12px;
            border-top: 1px solid #f0f2f5;
            padding-top: 12px;
        }

        .daily-list .item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .daily-list .item:last-child {
            border-bottom: none;
        }

        .daily-list .date {
            color: #455a64;
            font-weight: 600;
        }

        .daily-list .profit {
            font-weight: 700;
            color: #4caf50;
        }
        .weekly-list .profit {
            font-weight: 700;
            color: #4caf50;
        }
        .monthly-list .profit {
            font-weight: 700;
            color: #4caf50;
        }
        .daily-list .profit.negative {
            color: #ff5252;
        }

        .daily-list .trades {
            font-size: 12px;
            color: #757575;
            align-self: center;
        }

        /* Reuse list styles for weekly/monthly */
        .weekly-list,
        .monthly-list {
            margin-top: 12px;
            border-top: 1px solid #f0f2f5;
            padding-top: 12px;
        }

        .weekly-list .item,
        .monthly-list .item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .weekly-list .item:last-child,
        .monthly-list .item:last-child {
            border-bottom: none;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .metric {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px 12px;
        }

        .metric .label {
            font-size: 12px;
            color: #667;
        }

        .metric .value {
            font-weight: 700;
            margin-top: 4px;
        }

        /* Blank trade slot styling */
        .blank-row td {
            padding: 14px 12px;
        }

        .blank-slot {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #8d8d8d;
            background: linear-gradient(180deg, #fbfbfb, #f6f6f6);
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 14px;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .blank-slot:hover {
            background: #f9f9f9;
            transform: translateY(-1px);
        }

        .blank-slot .icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #eef2ff;
            color: #5b5fcf;
            font-weight: 700;
            font-size: 18px;
        }

        .blank-slot .text {
            font-weight: 600;
        }

        .blank-slot .subtitle {
            font-size: 12px;
            color: #aaa;
            margin-left: 6px;
        }

        /* Trade summary badges */
        .trade-summary {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            background: #f4f6ff;
            color: #4a57d0;
        }

        .badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .badge.green {
            background: #edf7ed;
            color: #2e7d32;
        }

        .badge.orange {
            background: #fff4e5;
            color: #ed6c02;
        }

        .badge.blue {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* Config summary */
        .config-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin: 10px 0 6px;
        }

        .pill {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 12px;
        }

        .pill .label {
            color: #8b949e;
            display: block;
            margin-bottom: 4px;
        }

        .pill .value {
            font-weight: 700;
            color: #e6edf3;
        }

        /* Simple bar for CPU */
        .bars {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }

        .bar {
            height: 10px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 999px;
            overflow: hidden;
        }

        .bar>span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #2ea043);
        }

        .bars-label {
            color: #8b949e;
            font-size: 12px;
            margin-top: 6px;
        }

        /* Logs output */
        .logs-output {
            margin-top: 16px;
            background: #0d1117;
            color: #c9d1d9;
            border-radius: 10px;
            padding: 16px;
            max-height: 500px;
            overflow: auto;
        }

        .logs-output .log-line {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .logs-output .lvl-info {
            color: #58a6ff;
        }

        .logs-output .lvl-warning {
            color: #e9b949;
        }

        .logs-output .lvl-error {
            color: #ff7b72;
        }

        .logs-output .lvl-debug {
            color: #8b949e;
        }
    </style>
</head>

<body>
    <!-- Bottom Navigation for Mobile -->
    <div class="bottom-nav">
        <div class="bottom-nav-container">
            <div class="bottom-nav-item active" onclick="showContent('profit')">
                <div class="bottom-nav-icon">💰</div>
                <div class="bottom-nav-label">Profit</div>
            </div>
            <div class="bottom-nav-item" onclick="showContent('trades')">
                <div class="bottom-nav-icon">📈</div>
                <div class="bottom-nav-label">Trades</div>
            </div>
            <div class="bottom-nav-item" onclick="showContent('log')">
                <div class="bottom-nav-icon">📝</div>
                <div class="bottom-nav-label">Logs</div>
            </div>
            <div class="bottom-nav-item" onclick="showContent('strategy')">
                <div class="bottom-nav-icon">🎯</div>
                <div class="bottom-nav-label">Strategy</div>
            </div>
            <div class="bottom-nav-item" onclick="showContent('control')">
                <div class="bottom-nav-icon">🎮</div>
                <div class="bottom-nav-label">Control</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">FreQ-Trade</div>

            <div class="profile">
                <div class="profile-img"><img
                        src="https://github.com/Rajasthanichora/GSS/blob/main/public/pwa-192x192.png?raw=true"
                        alt="PFP"></div>
                <div class="profile-info">
                    <div class="profile-name">Crypto Trader</div>
                    <div class="profile-loc">FreQ-Trade</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-item expandable expanded" onclick="toggleSection('dashboard')">
                    <span class="nav-item-icon">📊</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-subsection show" id="dashboard-sub">
                    <div class="nav-item" onclick="showContent('profit')">
                        <span class="nav-item-icon">💰</span>
                        <span>Profit</span>
                    </div>
                    <div class="nav-item" onclick="showContent('trades')">
                        <span class="nav-item-icon">📈</span>
                        <span>Trades</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-item" onclick="showContent('log')">
                    <span class="nav-item-icon">📝</span>
                    <span>Log Section</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-item" onclick="showContent('strategy')">
                    <span class="nav-item-icon">🎯</span>
                    <span>Strategy</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-item" onclick="showContent('control')">
                    <span class="nav-item-icon">🎮</span>
                    <span>Control Bot</span>
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-item">
                    <span class="nav-item-icon"></span>
                    <span></span>
                </div>
                <div class="nav-item">
                    <span class="nav-item-icon"></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section active">
                <div class="dashboard-grid">
                    <!-- Chart Card -->
                    <div class="card chart-card">
                        <div class="chart-header">
                            <h2 class="chart-title">Earnings Summary</h2>
                            <div class="chart-filters">
                                <button class="filter-btn" onclick="changeChartPeriod('days')">Days</button>
                                <button class="filter-btn active" onclick="changeChartPeriod('weekly')">Weekly</button>
                                <button class="filter-btn" onclick="changeChartPeriod('monthly')">Monthly</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="main-chart"></canvas>
                            <div id="chart-status" class="chart-status">Weekly</div>
                        </div>
                    </div>

                    <!-- Overview Card (Total Profit + Balance) -->
                    <div class="card earnings-card">
                        <div class="earnings-label">Overview</div>
                        <div class="earnings-amount" id="dashboard-total-profit">$0.00</div>
                        <div class="earnings-note" id="dashboard-balance-note">Balance: -</div>
                    </div>
                </div>

                <!-- Trades (Live) -->
                <div class="card">
                    <h2 style="margin-bottom: 12px;">Trades</h2>
                    <div id="trade-summary-dash" class="trade-summary" style="margin-bottom: 12px;"></div>
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>PAIR</th>
                                <th>OPEN RATE</th>
                                <th>CURRENT RATE</th>
                                <th>PNL</th>
                                <th>POSITION</th>
                                <th>ORDER TYPE</th>
                                <th>AMOUNT</th>
                                <th>OPEN TIME</th>
                            </tr>
                        </thead>
                        <tbody id="trades-list-dash"></tbody>
                    </table>
                </div>

                <!-- Circle Progress -->
                <div class="card">
                    <div class="circle-progress-container">
                        <svg class="circle-progress" viewBox="0 0 200 200">
                            <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                            <circle id="wins-arc" class="circle-progress-bar" cx="100" cy="100" r="90" stroke="#4caf50"
                                stroke-dasharray="565" stroke-dashoffset="339"></circle>
                            <circle id="losses-arc" class="circle-progress-bar" cx="100" cy="100" r="90"
                                stroke="#ff5252" stroke-dasharray="565" stroke-dashoffset="565"></circle>
                            <circle id="draws-arc" class="circle-progress-bar" cx="100" cy="100" r="90" stroke="#ffd700"
                                stroke-dasharray="565" stroke-dashoffset="565"></circle>
                        </svg>
                        <div class="circle-text">
                            <div class="circle-number" id="total-trades-number">0</div>
                            <div class="circle-label">Total Trades</div>
                        </div>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4caf50;"></div>
                            <span class="legend-text">Wins<span class="legend-value" id="wins-count">0</span></span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff6b6b;"></div>
                            <span class="legend-text">Losses<span class="legend-value" id="losses-count">0</span></span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffd700;"></div>
                            <span class="legend-text">Draws<span class="legend-value" id="draws-count">0</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profit Section -->
            <div id="profit-section" class="section">
                <h2 style="margin-bottom: 20px;">Profit Overview</h2>
                <div class="dashboard-grid">
                    <div class="card clickable" id="daily-profit-card" title="Click to fetch latest daily profit">
                        <h3>Daily Profit</h3>
                        <div id="daily-profit-amount" class="profit-amount">+0</div>
                        <p class="muted">Last 24 hours</p>
                        <div id="daily-profit-status" class="status-message" aria-live="polite"></div>
                        <div id="daily-profit-list" class="daily-list"></div>
                    </div>
                    <div class="card clickable" id="weekly-profit-card" title="Click to fetch latest weekly profit">
                        <h3>Weekly Profit</h3>
                        <div id="weekly-profit-amount" class="profit-amount">+0</div>
                        <p class="muted">Last 7 days</p>
                        <div id="weekly-profit-status" class="status-message" aria-live="polite"></div>
                        <div id="weekly-profit-list" class="weekly-list"></div>
                    </div>
                    <div class="card clickable" id="monthly-profit-card" title="Click to fetch latest monthly profit">
                        <h3>Monthly Profit</h3>
                        <div id="monthly-profit-amount" class="profit-amount">+0</div>
                        <p class="muted">Last 30 days</p>
                        <div id="monthly-profit-status" class="status-message" aria-live="polite"></div>
                        <div id="monthly-profit-list" class="monthly-list"></div>
                    </div>
                    <div class="card clickable" id="total-profit-card" title="Click to fetch overall profit metrics">
                        <h3>Total Profit</h3>
                        <div id="total-profit-amount" class="profit-amount" style="color:#5b5fcf;">$45,678.90</div>
                        <p class="muted">All time</p>
                        <div id="total-profit-status" class="status-message" aria-live="polite"></div>
                        <div id="total-profit-metrics" class="metrics-grid">
                            <div class="metric">
                                <div class="label">Trades</div>
                                <div class="value" id="tp-trade-count">-</div>
                            </div>
                            <div class="metric">
                                <div class="label">Profit %</div>
                                <div class="value" id="tp-profit-percent">-</div>
                            </div>
                            <div class="metric">
                                <div class="label">Profit (Fiat)</div>
                                <div class="value" id="tp-profit-fiat">-</div>
                            </div>
                            <div class="metric">
                                <div class="label">Winrate</div>
                                <div class="value" id="tp-winrate">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trades Section -->
            <div id="trades-section" class="section">
                <h2 style="margin-bottom: 20px;">All Trades</h2>
                <!-- Round chart duplicated for trades page -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="circle-progress-container">
                        <svg class="circle-progress" viewBox="0 0 200 200">
                            <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                            <circle id="wins-arc-2" class="circle-progress-bar" cx="100" cy="100" r="90"
                                stroke="#4caf50" stroke-dasharray="565" stroke-dashoffset="565"></circle>
                            <circle id="losses-arc-2" class="circle-progress-bar" cx="100" cy="100" r="90"
                                stroke="#ff5252" stroke-dasharray="565" stroke-dashoffset="565"></circle>
                            <circle id="draws-arc-2" class="circle-progress-bar" cx="100" cy="100" r="90"
                                stroke="#ffd700" stroke-dasharray="565" stroke-dashoffset="565"></circle>
                        </svg>
                        <div class="circle-text">
                            <div class="circle-number" id="total-trades-number-2">0</div>
                            <div class="circle-label">Total Trades</div>
                        </div>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4caf50;"></div>
                            <span class="legend-text">Wins<span class="legend-value" id="wins-count-2">0</span></span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff5252;"></div>
                            <span class="legend-text">Losses<span class="legend-value"
                                    id="losses-count-2">0</span></span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffd700;"></div>
                            <span class="legend-text">Draws<span class="legend-value" id="draws-count-2">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div id="trade-summary-all" class="trade-summary" style="margin-bottom: 12px;"></div>
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>PAIR</th>
                                <th>OPEN RATE</th>
                                <th>CURRENT RATE</th>
                                <th>PNL</th>
                                <th>POSITION</th>
                                <th>ORDER TYPE</th>
                                <th>AMOUNT</th>
                                <th>OPEN TIME</th>
                            </tr>
                        </thead>
                        <tbody id="trades-list-all"></tbody>
                    </table>
                </div>

                <!-- Closed Trades Section -->
                <div class="card" style="margin-top: 20px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                        <h3 style="margin:0;">Closed Trades</h3>
                        <button onclick="loadClosedTrades()"
                            style="margin-left:auto; background:#eef2ff; color:#4a57d0; border:none; border-radius:8px; padding:6px 10px; font-weight:600; cursor:pointer;">Refresh</button>
                    </div>
                    <div id="trade-summary-closed" class="trade-summary" style="margin-bottom: 12px;"></div>
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>PAIR</th>
                                <th>AMOUNT</th>
                                <th>OPEN RATE</th>
                                <th>CLOSE RATE</th>
                                <th>PROFIT RATIO</th>
                                <th>PNL</th>
                                <th>POSITION</th>
                                <th>DURATION</th>
                                <th>TOTAL FEE</th>
                                <th>TIME</th>
                            </tr>
                        </thead>
                        <tbody id="trades-list-closed"></tbody>
                    </table>
                </div>
            </div>

            <!-- Log Section -->
            <div id="log-section" class="section">
                <h2 style="margin-bottom: 20px;">Logs</h2>
                <div class="logs-grid">
                    <div class="log-card" onclick="fetchLog('log')">
                        <h3>📝 Logs</h3>
                        <p>View system logs</p>
                    </div>
                    <div class="log-card" onclick="fetchLog('config')">
                        <h3>⚙️ Config</h3>
                        <p>Configuration settings</p>
                    </div>
                    <div class="log-card" onclick="fetchLog('system')">
                        <h3>💻 System Info</h3>
                        <p>System information</p>
                    </div>
                    <div class="log-card" onclick="fetchLog('exchanges')">
                        <h3>🔄 Exchanges</h3>
                        <p>Exchange connections</p>
                    </div>
                </div>
                <div id="logs-output" class="logs-output" aria-live="polite"></div>
            </div>

            <!-- Strategy Section -->
            <div id="strategy-section" class="section">
                <h2 style="margin-bottom: 20px;">Trading Strategies</h2>
                <div id="strategies-grid"></div>
                <div id="strategy-detail" class="card" style="margin-top:16px; display:none;"></div>
            </div>

            <!-- Control Bot Section -->
            <div id="control-section" class="section">
                <h2 style="margin-bottom: 20px;">Bot Control Center</h2>

                <!-- Status Card -->
                <div id="bot-status-card" class="card" style="display:flex; flex-direction:column; gap:10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="bot-status-dot" class="trade-icon icon" style="background:#ccc;"></span>
                        <div style="font-weight:700;">Status: <span id="bot-status-text">Unknown</span></div>
                        <div style="margin-left:auto; color:#667; font-size:12px;">Run mode: <span
                                id="bot-runmode">-</span></div>
                    </div>
                    <div style="display:flex; gap:16px; color:#667; font-size:12px;">
                        <div>Uptime: <span id="bot-uptime">—</span></div>
                        <div>Last action: <span id="bot-last-action">—</span></div>
                    </div>
                </div>

                <!-- Actions Grid -->
                <div class="card" style="padding:0;">
                    <div
                        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; padding:16px;">
                        <div class="card"
                            style="cursor:pointer; text-align:center; background: linear-gradient(135deg, #2e7d32, #1b5e20); color:#fff; box-shadow: 0 8px 18px rgba(46,125,50,0.25);"
                            onclick="startBot()">
                            <div style="font-weight:700;">▶️ Start Bot</div>
                            <div style="opacity:0.9; font-size:12px;">Start the trading bot</div>
                        </div>
                        <div class="card"
                            style="cursor:pointer; text-align:center; background: linear-gradient(135deg, #d32f2f, #b71c1c); color:#fff; box-shadow: 0 8px 18px rgba(211,47,47,0.25);"
                            onclick="stopBot()">
                            <div style="font-weight:700;">⏹️ Stop Bot</div>
                            <div style="opacity:0.9; font-size:12px;">Stop the trading bot</div>
                        </div>
                        <div class="card"
                            style="cursor:pointer; text-align:center; background: linear-gradient(135deg, #1976d2, #0d47a1); color:#fff; box-shadow: 0 8px 18px rgba(25,118,210,0.25);"
                            onclick="reloadBotConfig()">
                            <div style="font-weight:700;">🔄 Reload Config</div>
                            <div style="opacity:0.9; font-size:12px;">Reload runtime configuration</div>
                        </div>
                        <div class="card"
                            style="cursor:pointer; text-align:center; background: linear-gradient(135deg, #ed6c02, #e65100); color:#fff; box-shadow: 0 8px 18px rgba(237,108,2,0.25);"
                            onclick="stopBuy()">
                            <div style="font-weight:700;">🛑 Stop Buy</div>
                            <div style="opacity:0.9; font-size:12px;">Temporarily stop buying</div>
                        </div>
                        <div class="card"
                            style="cursor:pointer; text-align:center; background: linear-gradient(135deg, #c62828, #8e0000); color:#fff; box-shadow: 0 8px 18px rgba(198,40,40,0.25);"
                            onclick="stopEntry()">
                            <div style="font-weight:700;">🚫 Stop Entry</div>
                            <div style="opacity:0.9; font-size:12px;">Block new entries</div>
                        </div>
                        <div class="card"
                            style="cursor:pointer; text-align:center; background: linear-gradient(135deg, #6a1b9a, #4a148c); color:#fff; box-shadow: 0 8px 18px rgba(106,27,154,0.25);"
                            onclick="pauseBot()">
                            <div style="font-weight:700;">⏸️ Pause Bot</div>
                            <div style="opacity:0.9; font-size:12px;">Pause processing</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Currency toggle
        let currentCurrency = 'USDT';
        // Strategy: lazy-load flag
        let strategyListLoaded = false;

        // Bottom navigation functions
        function showContent(section) {
            // Update bottom nav active states
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Set active state for clicked item
            event.currentTarget.classList.add('active');
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active');
            });

            // Show selected section
            const sectionElement = document.getElementById(section + '-section');
            if (sectionElement) {
                sectionElement.classList.add('active');
                // If Strategy section is opened, fetch strategies (only once)
                if (section === 'strategy') {
                    if (!window.__strategyListLoaded) {
                        if (typeof loadStrategies === 'function') loadStrategies();
                        window.__strategyListLoaded = true;
                    }
                }
                // If Control section is opened, refresh bot status
                if (section === 'control') {
                    if (typeof refreshBotStatus === 'function') refreshBotStatus();
                }
            } else if (section === 'profit') {
                document.getElementById('profit-section').classList.add('active');
            } else if (section === 'trades') {
                document.getElementById('trades-section').classList.add('active');
                // Lazy-load closed trades once when opening Trades section
                if (!window.__closedTradesLoaded) {
                    if (typeof loadClosedTrades === 'function') loadClosedTrades();
                    window.__closedTradesLoaded = true;
                }
            } else if (section === 'log' || section === 'config' || section === 'system' || section === 'exchanges') {
                document.getElementById('log-section').classList.add('active');
            } else if (section === 'strategy') {
                document.getElementById('strategy-section').classList.add('active');
                if (!window.__strategyListLoaded) {
                    if (typeof loadStrategies === 'function') loadStrategies();
                    window.__strategyListLoaded = true;
                }
            } else if (section === 'control') {
                document.getElementById('control-section').classList.add('active');
            }
        }

        function toggleCurrency() {
            currentCurrency = currentCurrency === 'USDT' ? 'INR' : 'USDT';
            const button = document.querySelector('.currency-toggle');
            button.textContent = currentCurrency === 'USDT' ? 'USDT / INR' : 'INR / USDT';

            // Old earnings element may not exist anymore; guard access
            const earningsElement = document.getElementById('earnings');
            if (earningsElement) {
                if (currentCurrency === 'INR') {
                    earningsElement.textContent = '₹1,03,340';
                } else {
                    earningsElement.textContent = '$1,245.06';
                }
            }
        }

        // Toggle sections
        function toggleSection(section) {
            const subsection = document.getElementById(section + '-sub');
            const navItem = event.currentTarget;

            if (subsection) {
                subsection.classList.toggle('show');
                navItem.classList.toggle('expanded');
            }
        }


        // Bot toggle
        function toggleBot(action) {
            const startBtn = document.getElementById('bot-start');
            const stopBtn = document.getElementById('bot-stop');

            if (action === 'start') {
                startBtn.classList.add('active');
                stopBtn.classList.remove('active');
                alert('Bot Started Successfully!');
            } else {
                startBtn.classList.remove('active');
                stopBtn.classList.add('active');
                alert('Bot Stopped!');
            }
        }

        // Fetch earnings
        function fetchEarnings() {
            const earningsElement = document.getElementById('earnings');
            earningsElement.style.animation = 'none';
            setTimeout(() => {
                earningsElement.style.animation = 'countUp 1s ease-out';
                const newAmount = Math.random() * 2000 + 1000;
                if (currentCurrency === 'INR') {
                    earningsElement.textContent = '₹' + (newAmount * 83).toFixed(2);
                } else {
                    earningsElement.textContent = '$' + newAmount.toFixed(2);
                }
            }, 100);
        }

        // Change chart period
        function changeChartPeriod(period) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            const mapping = period === 'days' ? 'daily' : period; // map Days -> daily
            updateChart(mapping);
        }

        // Fetch log
        async function getLogs() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/logs';
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        function renderLatestLogs(payload) {
            const out = document.getElementById('logs-output');
            if (!out) return;
            const root = Array.isArray(payload) ? payload[0] : payload;
            const logs = root && Array.isArray(root.logs) ? root.logs : [];
            const last100 = logs.slice(-100).reverse(); // latest 100 only, newest first
            if (!last100.length) {
                out.innerHTML = '<div class="log-line">No logs available.</div>';
                return;
            }
            const fmt = (row) => {
                // Expected: [ts_str, ts_ms, logger, level, message]
                const ts = row[0] || '';
                const logger = row[2] || '';
                const level = (row[3] || '').toUpperCase();
                const msg = row[4] || '';
                const lvlClass = level === 'ERROR' ? 'lvl-error' : level === 'WARNING' ? 'lvl-warning' : level === 'DEBUG' ? 'lvl-debug' : 'lvl-info';
                return `<div class="log-line ${lvlClass}">[${ts}] ${level} ${logger} - ${msg}</div>`;
            };
            out.innerHTML = last100.map(fmt).join('');
        }

        async function getConfig() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/show_config';
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        function renderConfig(payload) {
            const out = document.getElementById('logs-output');
            if (!out) return;
            const root = Array.isArray(payload) ? payload[0] : payload;
            const summary = `
                <div class="config-summary">
                    <div class="pill"><span class="label">Version</span><span class="value">${root.version ?? '-'}</span></div>
                    <div class="pill"><span class="label">Mode</span><span class="value">${root.trading_mode ?? '-'}</span></div>
                    <div class="pill"><span class="label">Exchange</span><span class="value">${root.exchange ?? '-'}</span></div>
                    <div class="pill"><span class="label">Strategy</span><span class="value">${root.strategy ?? '-'}</span></div>
                    <div class="pill"><span class="label">Stake</span><span class="value">${root.stake_currency ?? '-'} (${root.stake_amount ?? '-'})</span></div>
                    <div class="pill"><span class="label">Max Open Trades</span><span class="value">${root.max_open_trades ?? '-'}</span></div>
                    <div class="pill"><span class="label">Timeframe</span><span class="value">${root.timeframe ?? '-'}</span></div>
                    <div class="pill"><span class="label">Short Allowed</span><span class="value">${root.short_allowed ? 'Yes' : 'No'}</span></div>
                </div>
            `;
            const pretty = `<pre class="log-line">${JSON.stringify(root, null, 2)}</pre>`;
            out.innerHTML = `<div class="logs-output">${summary}${pretty}</div>`;
        }

        async function getSysInfo() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/sysinfo';
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        function renderSysInfo(payload) {
            const out = document.getElementById('logs-output');
            if (!out) return;
            const root = Array.isArray(payload) ? payload[0] : payload;
            const cpus = Array.isArray(root.cpu_pct) ? root.cpu_pct : [];
            const ram = typeof root.ram_pct === 'number' ? root.ram_pct : null;
            const barsHtml = cpus.map((v, i) => {
                const pct = Math.max(0, Math.min(100, Number(v) || 0));
                return `<div><div class="bars-label">CPU ${i + 1}: ${pct}%</div><div class="bar"><span style="width:${pct}%;"></span></div></div>`;
            }).join('');
            const ramHtml = `<div class="pill" style="display:inline-block; margin-top:10px;"><span class="label">RAM Usage</span><span class="value">${ram !== null ? ram + '%' : '-'}</span></div>`;
            out.innerHTML = `<div class="logs-output"><div class="bars">${barsHtml}</div>${ramHtml}</div>`;
        }

        async function getExchanges() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/exchanges';
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        function renderExchanges(payload) {
            const out = document.getElementById('logs-output');
            if (!out) return;
            const root = Array.isArray(payload) ? payload[0] : payload;
            const list = root && Array.isArray(root.exchanges) ? root.exchanges : [];
            const rows = list.map(x => {
                const modes = Array.isArray(x.trade_modes) ? x.trade_modes.map(m => `${m.trading_mode}${m.margin_mode ? ' (' + m.margin_mode + ')' : ''}`).join(', ') : '-';
                const support = x.supported ? '<span class="badge green"><span class="dot"></span> Supported</span>' : '<span class="badge orange"><span class="dot"></span> Partial/No</span>';
                return `
                    <tr>
                        <td>${x.name || '-'}</td>
                        <td>${x.classname || '-'}</td>
                        <td>${x.dex ? 'Yes' : 'No'}</td>
                        <td>${support}</td>
                        <td>${modes}</td>
                        <td>${x.comment || ''}</td>
                    </tr>
                `;
            }).join('');
            out.innerHTML = `
                <div class="logs-output">
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Class</th>
                                <th>DEX</th>
                                <th>Supported</th>
                                <th>Trade Modes</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        async function fetchLog(type) {
            const out = document.getElementById('logs-output');
            try {
                if (type === 'log') {
                    if (out) out.innerHTML = '<div class="log-line">Loading latest 100 logs...</div>';
                    const data = await getLogs();
                    renderLatestLogs(data);
                } else if (type === 'config') {
                    if (out) out.innerHTML = '<div class="log-line">Loading configuration...</div>';
                    const data = await getConfig();
                    renderConfig(data);
                } else if (type === 'system') {
                    if (out) out.innerHTML = '<div class="log-line">Loading system info...</div>';
                    const data = await getSysInfo();
                    renderSysInfo(data);
                } else if (type === 'exchanges') {
                    if (out) out.innerHTML = '<div class="log-line">Loading exchanges...</div>';
                    const data = await getExchanges();
                    renderExchanges(data);
                }
            } catch (e) {
                if (out) out.innerHTML = `<div class="log-line lvl-error">Failed to fetch: ${e.message || 'Unknown error'}</div>`;
                console.error('Fetch error:', e);
            }
        }

        // Toggle strategy dropdown
        function toggleStrategy(element) {
            const details = element.nextElementSibling;
            details.classList.toggle('open');
            const arrow = element.querySelector('span:last-child');
            arrow.textContent = details.classList.contains('open') ? '▲' : '▼';
        }

        // Control functions
        function reloadConfig() {
            alert('Configuration reloaded successfully!');
        }

        function stopBuy() {
            alert('Buy orders stopped!');
        }

        function stopEntry() {
            alert('Entry stopped!');
        }

        function pauseBot() {
            alert('Bot paused!');
        }

        // ================= Chart: Canvas Line Renderer =================
        let chartCtx = null;
        let chartCanvas = null;
        let chartPoints = [];
        let onCanvasMove;
        function initChart() {
            chartCanvas = document.getElementById('main-chart');
            if (!chartCanvas) return;
            chartCtx = chartCanvas.getContext('2d');
            // Ensure proper resolution on high-DPI screens
            const rect = chartCanvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            chartCanvas.width = rect.width * dpr;
            chartCanvas.height = rect.height * dpr;
            chartCtx.scale(dpr, dpr);

            // Attach resize handler for crispness
            window.addEventListener('resize', () => {
                const r = chartCanvas.getBoundingClientRect();
                const d = window.devicePixelRatio || 1;
                chartCanvas.width = r.width * d;
                chartCanvas.height = r.height * d;
                chartCtx.setTransform(1, 0, 0, 1, 0, 0);
                chartCtx.scale(d, d);
                drawLineChart(chartPoints);
            }, { passive: true });
        }

        function drawLineChart(points, options = {}) {
            if (!chartCtx || !chartCanvas) return;
            // Keep a copy for redraws (resize / hover)
            chartPoints = Array.isArray(points) ? points.slice() : [];
            // Sort by time for correctness
            chartPoints.sort((a, b) => (a.x?.getTime?.() || 0) - (b.x?.getTime?.() || 0));

            const rect = chartCanvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            // Clear
            chartCtx.clearRect(0, 0, width, height);

            // Padding
            const pad = { top: 20, right: 20, bottom: 36, left: 56 };
            const innerW = width - pad.left - pad.right;
            const innerH = height - pad.top - pad.bottom;

            if (!chartPoints || chartPoints.length === 0) return;

            // Y scale
            let minY = Math.min(...chartPoints.map(p => p.y));
            let maxY = Math.max(...chartPoints.map(p => p.y));
            // Anchor around zero if values cross it or are very close
            const crossesZero = minY <= 0 && maxY >= 0;
            if (crossesZero) {
                minY = Math.min(minY, 0);
                maxY = Math.max(maxY, 0);
            }
            if (minY === maxY) { minY -= 1; maxY += 1; }
            const yPad = (maxY - minY) * 0.1;
            minY -= yPad; maxY += yPad;
            const yToPix = y => pad.top + innerH - ((y - minY) / (maxY - minY)) * innerH;

            // X scale (uniform spacing)
            const xStep = innerW / Math.max(1, chartPoints.length - 1);
            const xAt = i => pad.left + i * xStep;

            // Axes
            chartCtx.strokeStyle = '#e0e0e0';
            chartCtx.lineWidth = 1;
            // X axis
            chartCtx.beginPath();
            chartCtx.moveTo(pad.left, pad.top + innerH);
            chartCtx.lineTo(pad.left + innerW, pad.top + innerH);
            chartCtx.stroke();
            // Y axis
            chartCtx.beginPath();
            chartCtx.moveTo(pad.left, pad.top);
            chartCtx.lineTo(pad.left, pad.top + innerH);
            chartCtx.stroke();

            // Gridlines and Y ticks (5 lines)
            chartCtx.strokeStyle = '#f0f2f5';
            chartCtx.fillStyle = '#889';
            chartCtx.font = '12px sans-serif';
            const ticks = 5;
            for (let i = 0; i <= ticks; i++) {
                const t = i / ticks;
                const y = pad.top + innerH * t;
                chartCtx.beginPath();
                chartCtx.moveTo(pad.left, y);
                chartCtx.lineTo(pad.left + innerW, y);
                chartCtx.stroke();
                // Label
                const val = (maxY - (maxY - minY) * t);
                const txt = val.toFixed(2);
                chartCtx.fillText(txt, 8, y + 4);
            }

            // Line (smooth Bezier)
            const color = options.color || '#5b5fcf';
            chartCtx.lineWidth = 2;
            chartCtx.strokeStyle = color;
            chartCtx.beginPath();
            for (let i = 0; i < chartPoints.length; i++) {
                const x = xAt(i);
                const y = yToPix(chartPoints[i].y);
                if (i === 0) {
                    chartCtx.moveTo(x, y);
                } else {
                    const xPrev = xAt(i - 1);
                    const yPrev = yToPix(chartPoints[i - 1].y);
                    const cx = (xPrev + x) / 2;
                    chartCtx.bezierCurveTo(cx, yPrev, cx, y, x, y);
                }
            }
            chartCtx.stroke();

            // Area fill (gradient)
            const grad = chartCtx.createLinearGradient(0, pad.top, 0, pad.top + innerH);
            grad.addColorStop(0, 'rgba(91,95,207,0.22)');
            grad.addColorStop(1, 'rgba(91,95,207,0.02)');
            chartCtx.fillStyle = grad;
            chartCtx.beginPath();
            for (let i = 0; i < chartPoints.length; i++) {
                const x = xAt(i);
                const y = yToPix(chartPoints[i].y);
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            }
            chartCtx.lineTo(pad.left + innerW, pad.top + innerH);
            chartCtx.lineTo(pad.left, pad.top + innerH);
            chartCtx.closePath();
            chartCtx.fill();

            // Points
            chartCtx.fillStyle = options.pointColor || '#5b5fcf';
            chartPoints.forEach((p, i) => {
                const x = xAt(i);
                const y = yToPix(p.y);
                chartCtx.beginPath();
                chartCtx.arc(x, y, 2.5, 0, Math.PI * 2);
                chartCtx.fill();
            });

            // Labels: first, middle, last date
            chartCtx.fillStyle = '#666';
            chartCtx.font = '12px sans-serif';
            const labelY = pad.top + innerH + 24;
            const formatDate = d => d.toLocaleDateString('en-IN');
            if (chartPoints.length >= 1) {
                chartCtx.fillText(formatDate(chartPoints[0].x), pad.left, labelY);
            }
            if (chartPoints.length >= 3) {
                const mid = Math.floor(chartPoints.length / 2);
                chartCtx.fillText(formatDate(chartPoints[mid].x), pad.left + innerW / 2 - 30, labelY);
            }
            if (chartPoints.length >= 2) {
                const lastTxt = formatDate(chartPoints[chartPoints.length - 1].x);
                chartCtx.fillText(lastTxt, pad.left + innerW - chartCtx.measureText(lastTxt).width, labelY);
            }

            // Tooltip hover
            const hitRadius = 8;
            const pickIndexAt = (mx) => {
                const rel = Math.max(pad.left, Math.min(mx, pad.left + innerW));
                const approx = Math.round((rel - pad.left) / xStep);
                return Math.max(0, Math.min(chartPoints.length - 1, approx));
            };
            const drawTooltip = (idx) => {
                if (idx == null || idx < 0 || idx >= chartPoints.length) return;
                const p = chartPoints[idx];
                const x = xAt(idx);
                const y = yToPix(p.y);
                // Vertical line
                chartCtx.strokeStyle = 'rgba(91,95,207,0.35)';
                chartCtx.lineWidth = 1;
                chartCtx.beginPath();
                chartCtx.moveTo(x, pad.top);
                chartCtx.lineTo(x, pad.top + innerH);
                chartCtx.stroke();
                // Marker
                chartCtx.fillStyle = '#fff';
                chartCtx.beginPath(); chartCtx.arc(x, y, 4, 0, Math.PI * 2); chartCtx.fill();
                chartCtx.strokeStyle = color; chartCtx.stroke();
                // Box
                const txt = `${p.x.toLocaleDateString('en-IN')}  ${p.y}`;
                chartCtx.font = '12px sans-serif';
                const tw = chartCtx.measureText(txt).width + 12;
                const th = 22;
                const bx = Math.min(Math.max(x - tw / 2, pad.left), pad.left + innerW - tw);
                const by = Math.max(pad.top + 6, y - 32);
                chartCtx.fillStyle = '#1f2437';
                chartCtx.globalAlpha = 0.92;
                chartCtx.fillRect(bx, by, tw, th);
                chartCtx.globalAlpha = 1;
                chartCtx.fillStyle = '#fff';
                chartCtx.fillText(txt, bx + 6, by + 14);
            };
            if (onCanvasMove) chartCanvas.removeEventListener('mousemove', onCanvasMove);
            onCanvasMove = (ev) => {
                const rect = chartCanvas.getBoundingClientRect();
                const mx = ev.clientX - rect.left;
                const my = ev.clientY - rect.top;
                // Redraw background first
                drawLineChart(chartPoints, options);
                // If pointer is within plot area, show tooltip
                if (mx >= pad.left - hitRadius && mx <= pad.left + innerW + hitRadius && my >= pad.top - hitRadius && my <= pad.top + innerH + hitRadius) {
                    const idx = pickIndexAt(mx);
                    drawTooltip(idx);
                }
            };
            chartCanvas.addEventListener('mousemove', onCanvasMove, { passive: true });
            chartCanvas.addEventListener('mouseleave', () => drawLineChart(chartPoints, options), { passive: true });
        }

        async function updateChart(period) {
            const status = document.getElementById('chart-status');
            if (status) status.textContent = period.charAt(0).toUpperCase() + period.slice(1);
            try {
                let payload;
                if (period === 'daily') payload = await getDailyData();
                else if (period === 'weekly') payload = await getWeeklyData();
                else if (period === 'monthly') payload = await getMonthlyData();
                else payload = await getWeeklyData();

                const root = Array.isArray(payload) ? payload[0] : payload;
                const rows = root && Array.isArray(root.data) ? root.data : [];
                const points = rows.map(r => ({ x: new Date(r.date), y: Number(r.abs_profit || 0) }));
                initChart();
                drawLineChart(points);
            } catch (e) {
                console.error('Failed to update chart:', e);
            }
        }

        // Daily Profit: Fetch + Render
        async function getDailyData() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/daily';
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const dailyData = await response.json();
                console.log('Daily Data:', dailyData);
                return dailyData;
            } catch (error) {
                console.error('Failed to fetch daily data:', error);
                throw error;
            }
        }

        function renderDailyData(payload) {
            // Expecting payload like: [{ data: [ {date, abs_profit, rel_profit, starting_balance, fiat_value, trade_count}...], ... }]
            const container = document.getElementById('daily-profit-list');
            const status = document.getElementById('daily-profit-status');
            const amount = document.getElementById('daily-profit-amount');
            container.innerHTML = '';

            const root = Array.isArray(payload) ? payload[0] : payload;
            let rows = root && Array.isArray(root.data) ? root.data : [];

            if (!rows.length) {
                container.innerHTML = '<div class="muted">No daily data available.</div>';
                return;
            }

            // Sort newest first by date
            rows = rows.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

            const formatted = rows.slice(0, 7).map(item => {
                const date = new Date(item.date).toLocaleDateString();
                const profit = Number(item.abs_profit || 0);
                const profitText = (profit >= 0 ? '+' : '') + profit.toFixed(4);
                const profitClass = 'profit' + (profit < 0 ? ' negative' : '');
                const trades = Number(item.trade_count || 0);
                return `
                    <div class="item">
                        <div class="date">${date}</div>
                        <div class="${profitClass}">${profitText}</div>
                        <div class="trades">Trades: ${trades}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = formatted;
            status.textContent = 'profit fetched';
            status.classList.remove('error');
            status.classList.add('success');

            // Update headline with latest day value
            const latest = rows[0];
            if (latest && typeof latest.abs_profit !== 'undefined' && amount) {
                const p = Number(latest.abs_profit);
                const sign = p >= 0 ? '+' : '';
                amount.textContent = `${sign}${p}`;
                amount.style.color = p >= 0 ? '#4caf50' : '#ff5252';
            }
        }

        async function handleDailyProfitClick() {
            const status = document.getElementById('daily-profit-status');
            const amount = document.getElementById('daily-profit-amount');
            status.textContent = 'Fetching...';
            status.classList.remove('success', 'error');

            try {
                const data = await getDailyData();
                renderDailyData(data);
                // Update dashboard chart
                updateChart('daily');
            } catch (err) {
                status.textContent = `Failed: ${err.message || 'Unable to fetch'}`;
                status.classList.add('error');
            }
        }

        // Auto-load Profit section data once when opened
        async function loadProfitSectionOnce() {
            if (window.__profitLoaded) return;
            try {
                const [d, w, m] = await Promise.all([
                    getDailyData().catch(e => null),
                    getWeeklyData().catch(e => null),
                    getMonthlyData().catch(e => null)
                ]);
                if (d) renderDailyData(d);
                if (w) renderWeeklyData(w);
                if (m) renderMonthlyData(m);
            } finally {
                window.__profitLoaded = true;
            }
        }

        // Weekly Profit: Fetch + Render
        async function getWeeklyData() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/weekly';
            try {
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                        'Content-Type': 'application/json'
                    }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                return await res.json();
            } catch (e) {
                console.error('Failed to fetch weekly data:', e);
                throw e;
            }
        }

        function renderWeeklyData(payload) {
            const container = document.getElementById('weekly-profit-list');
            const status = document.getElementById('weekly-profit-status');
            const amount = document.getElementById('weekly-profit-amount');
            container.innerHTML = '';

            const root = Array.isArray(payload) ? payload[0] : payload;
            let rows = root && Array.isArray(root.data) ? root.data : [];

            if (!rows.length) {
                container.innerHTML = '<div class="muted">No weekly data available.</div>';
                return;
            }

            // Sort newest first
            rows = rows.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

            const formatted = rows.slice(0, 7).map(item => {
                const date = new Date(item.date).toLocaleDateString();
                const profit = Number(item.abs_profit || 0);
                const profitText = (profit >= 0 ? '+' : '') + profit.toFixed(4);
                const profitClass = 'profit' + (profit < 0 ? ' negative' : '');
                const trades = Number(item.trade_count || 0);
                return `
                    <div class="item">
                        <div class="date">${date}</div>
                        <div class="${profitClass}">${profitText}</div>
                        <div class="trades">Trades: ${trades}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = formatted;
            status.textContent = 'profit fetched';
            status.classList.remove('error');
            status.classList.add('success');

            // Update headline with latest value
            const latest = rows[0];
            if (latest && typeof latest.abs_profit !== 'undefined' && amount) {
                const p = Number(latest.abs_profit);
                const sign = p >= 0 ? '+' : '';
                amount.textContent = `${sign}${p}`;
                amount.style.color = p >= 0 ? '#4caf50' : '#ff5252';
            }
        }

        async function handleWeeklyProfitClick() {
            const status = document.getElementById('weekly-profit-status');
            const amount = document.getElementById('weekly-profit-amount');
            status.textContent = 'Fetching...';
            status.classList.remove('success', 'error');
            try {
                const data = await getWeeklyData();
                renderWeeklyData(data);
                // Update dashboard chart
                updateChart('weekly');
            } catch (err) {
                status.textContent = `Failed: ${err.message || 'Unable to fetch'}`;
                status.classList.add('error');
            }
        }

        // Monthly Profit: Fetch + Render
        async function getMonthlyData() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/monthly';
            try {
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                        'Content-Type': 'application/json'
                    }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                return await res.json();
            } catch (e) {
                console.error('Failed to fetch monthly data:', e);
                throw e;
            }
        }

        function renderMonthlyData(payload) {
            const container = document.getElementById('monthly-profit-list');
            const status = document.getElementById('monthly-profit-status');
            const amount = document.getElementById('monthly-profit-amount');
            container.innerHTML = '';

            const root = Array.isArray(payload) ? payload[0] : payload;
            let rows = root && Array.isArray(root.data) ? root.data : [];

            if (!rows.length) {
                container.innerHTML = '<div class="muted">No monthly data available.</div>';
                return;
            }

            // Sort newest first (robust parsing: supports 'YYYY-MM' by appending '-01')
            const toTs = (s) => {
                let ts = Date.parse(s);
                if (isNaN(ts)) ts = Date.parse(String(s) + '-01');
                return isNaN(ts) ? null : ts;
            };
            rows = rows.slice().sort((a, b) => {
                const tb = toTs(b.date), ta = toTs(a.date);
                if (tb == null && ta == null) return 0;
                if (tb == null) return 1;
                if (ta == null) return -1;
                return tb - ta;
            });

            const formatted = rows.slice(0, 7).map(item => {
                const date = new Date(item.date).toLocaleDateString();
                const profit = Number(item.abs_profit || 0);
                const profitText = (profit >= 0 ? '+' : '') + profit.toFixed(4);
                const profitClass = 'profit' + (profit < 0 ? ' negative' : '');
                const trades = Number(item.trade_count || 0);
                return `
                    <div class="item">
                        <div class="date">${date}</div>
                        <div class="${profitClass}">${profitText}</div>
                        <div class="trades">Trades: ${trades}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = formatted;
            status.textContent = 'profit fetched';
            status.classList.remove('error');
            status.classList.add('success');

            // Update headline with latest value (use robust ts selection)
            const rowsWithTs = rows.map(r => ({ r, ts: toTs(r.date) }));
            const latestObj = rowsWithTs.reduce((acc, cur) => {
                if (cur.ts == null) return acc;
                if (acc == null || cur.ts > acc.ts) return cur;
                return acc;
            }, null);
            const latest = latestObj ? latestObj.r : rows[0];
            if (latest && typeof latest.abs_profit !== 'undefined' && amount) {
                const p = Number(latest.abs_profit);
                const sign = p >= 0 ? '+' : '';
                amount.textContent = `${sign}${p}`;
                amount.style.color = p >= 0 ? '#4caf50' : '#ff5252';
            }
        }

        async function handleMonthlyProfitClick() {
            const status = document.getElementById('monthly-profit-status');
            const amount = document.getElementById('monthly-profit-amount');
            status.textContent = 'Fetching...';
            status.classList.remove('success', 'error');
            try {
                const data = await getMonthlyData();
                renderMonthlyData(data);
                // Update dashboard chart
                updateChart('monthly');
            } catch (err) {
                status.textContent = `Failed: ${err.message || 'Unable to fetch'}`;
                status.classList.add('error');
            }
        }

        // Profit All (Total): Fetch + Render
        async function getProfitAll() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/profit_all';
            try {
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                        'Content-Type': 'application/json'
                    }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                return await res.json();
            } catch (e) {
                console.error('Failed to fetch profit_all:', e);
                throw e;
            }
        }

        function renderProfitAll(payload) {
            const status = document.getElementById('total-profit-status');
            const amount = document.getElementById('total-profit-amount');
            const tradeCount = document.getElementById('tp-trade-count');
            const profitPercent = document.getElementById('tp-profit-percent');
            const profitFiat = document.getElementById('tp-profit-fiat');
            const winrate = document.getElementById('tp-winrate');

            const root = Array.isArray(payload) ? payload[0] : payload;
            const all = root && root.all ? root.all : null;
            if (!all) {
                status.textContent = 'No total data available';
                status.classList.add('error');
                return;
            }

            // Update headline amount (prefer profit_all_fiat if available)
            if (typeof all.profit_all_fiat !== 'undefined') {
                const p = Number(all.profit_all_fiat);
                const sign = p >= 0 ? '+' : '';
                amount.textContent = `${sign}${p.toFixed(2)}`;
                amount.style.color = p >= 0 ? '#4caf50' : '#ff5252';
            }

            tradeCount.textContent = String(all.trade_count ?? '-');
            if (typeof all.profit_all_percent !== 'undefined') {
                profitPercent.textContent = `${Number(all.profit_all_percent).toFixed(2)}%`;
            } else if (typeof all.profit_all_ratio !== 'undefined') {
                profitPercent.textContent = `${(Number(all.profit_all_ratio) * 100).toFixed(2)}%`;
            } else {
                profitPercent.textContent = '-';
            }
            if (typeof all.profit_all_fiat !== 'undefined') {
                profitFiat.textContent = Number(all.profit_all_fiat).toFixed(2);
            } else {
                profitFiat.textContent = '-';
            }
            winrate.textContent = typeof all.winrate !== 'undefined' ? `${Number(all.winrate).toFixed(2)}%` : '-';

            status.textContent = 'profit fetched';
            status.classList.remove('error');
            status.classList.add('success');
        }

        async function handleTotalProfitClick() {
            const status = document.getElementById('total-profit-status');
            status.textContent = 'Fetching...';
            status.classList.remove('success', 'error');
            try {
                const data = await getProfitAll();
                renderProfitAll(data);
            } catch (err) {
                status.textContent = `Failed: ${err.message || 'Unable to fetch'}`;
                status.classList.add('error');
            }
        }

        // Attach click handler after DOM ready (script is at the end so it's safe)
        document.addEventListener('DOMContentLoaded', () => {
            const dailyCard = document.getElementById('daily-profit-card');
            if (dailyCard) dailyCard.addEventListener('click', handleDailyProfitClick);
            const weeklyCard = document.getElementById('weekly-profit-card');
            if (weeklyCard) weeklyCard.addEventListener('click', handleWeeklyProfitClick);
            const monthlyCard = document.getElementById('monthly-profit-card');
            if (monthlyCard) monthlyCard.addEventListener('click', handleMonthlyProfitClick);
            const totalCard = document.getElementById('total-profit-card');
            if (totalCard) totalCard.addEventListener('click', handleTotalProfitClick);
            // Initialize chart with weekly by default
            updateChart('weekly');
            // Fetch overview (total profit + balance)
            fetchOverview();
            // Auto-fetch profit section data for all cards on load
            handleDailyProfitClick();
            handleWeeklyProfitClick();
            handleMonthlyProfitClick();
            handleTotalProfitClick();
            // Fetch trades count/stats/status and update round charts & tables
            fetchTradesAndStats();
        });

        // ================= Overview: Profit + Balance =================
        async function getBalance() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/balance';
            try {
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                        'Content-Type': 'application/json'
                    }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                return await res.json();
            } catch (e) {
                console.error('Failed to fetch balance:', e);
                throw e;
            }
        }

        async function fetchOverview() {
            try {
                const [statusRes, balance] = await Promise.all([
                    getTradeStatus(),
                    getBalance()
                ]);
                // Compute live PnL from open trades
                const openTrades = Array.isArray(statusRes) ? statusRes : [];
                let pnlAbs = 0;
                for (const t of openTrades) {
                    if (typeof t.profit_abs === 'number') {
                        pnlAbs += t.profit_abs;
                    } else if (typeof t.profit_pct === 'number') {
                        const stake = Number(t.stake_amount || 0);
                        pnlAbs += stake * (Number(t.profit_pct) / 100);
                    } else if (typeof t.profit_ratio === 'number') {
                        const stake = Number(t.stake_amount || 0);
                        pnlAbs += stake * Number(t.profit_ratio);
                    }
                }
                const totalEl = document.getElementById('dashboard-total-profit');
                if (totalEl) {
                    const sign = pnlAbs >= 0 ? '+' : '';
                    totalEl.textContent = `${sign}${pnlAbs.toFixed(3)}`;
                    totalEl.style.color = pnlAbs >= 0 ? '#4caf50' : '#ff5252';
                }

                // Update balance note
                const noteEl = document.getElementById('dashboard-balance-note');
                const bRoot = Array.isArray(balance) ? balance[0] : balance;
                if (noteEl && bRoot) {
                    const stake = bRoot.stake || '';
                    const totalVal = typeof bRoot.value !== 'undefined' ? Number(bRoot.value).toFixed(2) : '-';
                    const botVal = typeof bRoot.value_bot !== 'undefined' ? Number(bRoot.value_bot).toFixed(2) : '-';
                    noteEl.textContent = `Balance (${stake}): total ${totalVal} | bot ${botVal}`;
                }
            } catch (e) {
                console.error('Failed to fetch overview:', e);
            }
        }

        // Add sample trades dynamically
        function addRandomTrade() {
            const pairs = ['BTC/USDT', 'ETH/USDT', 'SOL/USDT', 'ADA/USDT', 'DOT/USDT'];
            const pair = pairs[Math.floor(Math.random() * pairs.length)];
            const openRate = (Math.random() * 100000).toFixed(2);
            const currentRate = (openRate * (0.95 + Math.random() * 0.1)).toFixed(2);
            const pnl = ((currentRate - openRate) / openRate * 100).toFixed(2);

            const tradesTable = document.getElementById('trades-list');
            const newRow = tradesTable.insertRow();
            newRow.innerHTML = `
                <td>
                    <div class="trade-pair">
                        <div class="trade-icon icon"></div>
                        <span>${pair}</span>
                    </div>
                </td>
                <td>$${openRate}</td>
                <td>$${currentRate}</td>
                <td style="color: ${pnl >= 0 ? '#4caf50' : '#ff5252'};">${pnl >= 0 ? '+' : ''}${pnl}%</td>
            `;

            // Remove oldest trade if more than 10
            if (tradesTable.rows.length > 10) {
                tradesTable.deleteRow(0);
            }
        }

        // ===== Trades: Count/Status/Stats & Rendering =====
        async function getTradeCount() {
            const res = await fetch('https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/count', {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        async function getTradeStatus() {
            const res = await fetch('https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/status', {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        async function getTradeStats() {
            const res = await fetch('https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/stats', {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }



        function renderTradesTables(statusList) {
            const toIST = (ts, fallback) => {
                if (!ts && !fallback) return '-';
                try {
                    const d = ts ? new Date(Number(ts)) : new Date(fallback);
                    const time = d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata' });
                    const date = d.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'Asia/Kolkata' });
                    return `${time} | ${date}`;
                } catch { return '-'; }
            };

            const buildRow = (t) => {
                const rawPair = t.pair || '-';
                const pair = String(rawPair).split(':')[0]; // e.g., SOL/USDT:USDT -> SOL/USDT
                const openRate = (t.open_rate != null) ? `$${Number(t.open_rate).toFixed(2)}` : '-';
                const currentRate = (t.current_rate != null) ? `$${Number(t.current_rate).toFixed(2)}` : '-';
                const pnl = (t.profit_pct != null) ? `${t.profit_pct >= 0 ? '+' : ''}${Number(t.profit_pct).toFixed(2)}%` : '-';
                const pnlColor = (t.profit_pct != null) ? (t.profit_pct >= 0 ? '#4caf50' : '#ff5252') : '#666';
                const position = t.is_short ? 'SELL' : 'BUY';
                const orderType = (t.orders && t.orders[0] && t.orders[0].order_type) ? t.orders[0].order_type : '-';
                const amount = (typeof t.stake_amount !== 'undefined') ? Number(t.stake_amount).toFixed(4) : '-';
                const openTime = toIST(t.open_timestamp, t.open_date);
                return `
                    <tr>
                        <td data-label="Pair">${pair}</td>
                        <td data-label="Open Rate">${openRate}</td>
                        <td data-label="Current Rate">${currentRate}</td>
                        <td data-label="PNL" style="color:${pnlColor};">${pnl}</td>
                        <td data-label="Position">${position}</td>
                        <td data-label="Order Type">${orderType}</td>
                        <td data-label="Amount">${amount}</td>
                        <td data-label="Open Time">${openTime}</td>
                    </tr>
                `;
            };

            const dashBody = document.getElementById('trades-list-dash');
            const allBody = document.getElementById('trades-list-all');
            const list = Array.isArray(statusList) ? statusList : [];
            const rows = list.map(buildRow);
            const html = rows.join('');
            if (dashBody) dashBody.innerHTML = html;
            if (allBody) allBody.innerHTML = html;
        }

        async function fetchTradesAndStats() {
            try {
                const [countRes, statusRes, statsRes, totalRes] = await Promise.all([
                    getTradeCount(), getTradeStatus(), getTradeStats(), getProfitAll()
                ]);
                const count = Array.isArray(countRes) ? countRes[0] : countRes;
                const statusList = Array.isArray(statusRes) ? statusRes : [];
                const stats = Array.isArray(statsRes) ? statsRes[0] : statsRes;
                const totalRoot = Array.isArray(totalRes) ? totalRes[0] : totalRes;
                const totalTrades = (totalRoot && totalRoot.all && typeof totalRoot.all.trade_count !== 'undefined') ? Number(totalRoot.all.trade_count) : 0;
                // Circle progress is now handled by refreshStatsCircles() using exit_reasons.force_exit
                const maxSlots = Number(count?.max) || 3;
                renderTradesTables(statusList, maxSlots);

                // Update summaries
                const dashSummary = document.getElementById('trade-summary-dash');
                const allSummary = document.getElementById('trade-summary-all');
                const current = Number(count?.current) || 0;
                const max = Number(count?.max) || 0;
                const totalStake = typeof count?.total_stake !== 'undefined' ? Number(count.total_stake).toFixed(4) : '-';
                const summaryHtml = `
                    <span class="badge green"><span class="dot"></span> Current: ${current}</span>
                    <span class="badge orange"><span class="dot"></span> Max: ${max}</span>
                `;
                if (dashSummary) dashSummary.innerHTML = summaryHtml;
                if (allSummary) allSummary.innerHTML = summaryHtml;
            } catch (e) {
                console.error('Failed to fetch trades/stats:', e);
            }
        }

        // ===== Strategy: fetch + render simple cards on first open =====
        async function getStrategies() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/strategies';
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        function renderStrategiesList(payload) {
            const grid = document.getElementById('strategies-grid');
            if (!grid) return;
            const root = Array.isArray(payload) ? payload[0] : payload;
            const names = root && Array.isArray(root.strategies) ? root.strategies : [];
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(260px, 1fr))';
            grid.style.gap = '16px';
            if (!names.length) {
                grid.innerHTML = '<div class="card">No strategies available.</div>';
                return;
            }
            grid.innerHTML = names.map(n => `
                <div class="card" onclick=\"loadStrategyDetail('${n}')\" style=\"cursor:pointer;\">
                    <div style=\"display:flex; align-items:center; gap:10px;\">
                        <div class=\"trade-icon icon\"></div>
                        <div style=\"font-weight:700;\">${n}</div>
                    </div>
                </div>
            `).join('');
        }

        async function loadStrategies() {
            const grid = document.getElementById('strategies-grid');
            if (grid) grid.innerHTML = '<div class="card">Loading strategies...</div>';
            try {
                const data = await getStrategies();
                renderStrategiesList(data);
            } catch (e) {
                if (grid) grid.innerHTML = `<div class=\"card\">Failed to load strategies: ${e.message || 'Unknown error'}</div>`;
                console.error('Failed to fetch strategies:', e);
            }
        }

        // ===== Strategy detail: fetch + render key settings =====
        async function getStrategyDetail(name) {
            const url = `https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/strategy/${encodeURIComponent(name)}`;
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        function parseStrategyInfo(root) {
            // Fallbacks
            const info = {
                name: root.strategy || '-',
                timeframe: root.timeframe || '-',
                can_short: null,
                minimal_roi: null,
                minimal_roi_map: [],
                stoploss: null,
                trailing_stop: null,
                trailing_stop_positive: null,
                trailing_stop_positive_offset: null,
                trailing_only_offset_is_reached: null,
                process_only_new_candles: null,
                startup_candle_count: null,
                interface_version: null,
            };
            const code = typeof root.code === 'string' ? root.code : '';
            const getBool = (re) => {
                const m = code.match(re);
                if (!m) return null;
                return /true/i.test(m[1]);
            };
            const getNum = (re) => {
                const m = code.match(re);
                if (!m) return null;
                const v = parseFloat(m[1]);
                return isNaN(v) ? null : v;
            };
            const getInt = (re) => {
                const m = code.match(re);
                if (!m) return null;
                const v = parseInt(m[1], 10);
                return isNaN(v) ? null : v;
            };
            const roiMatch = code.match(/minimal_roi\s*=\s*\{([\s\S]*?)\}/);
            if (roiMatch) {
                // Try to extract first key:value
                const kv = roiMatch[1].match(/"?(\d+)"?\s*:\s*([\d.]+)/);
                if (kv) info.minimal_roi = { t: parseInt(kv[1], 10), value: parseFloat(kv[2]) };
                // Build full map (sorted by time)
                const all = Array.from(roiMatch[1].matchAll(/"?(\d+)"?\s*:\s*([\d.]+)/g)).map(m => ({ t: parseInt(m[1], 10), value: parseFloat(m[2]) }));
                info.minimal_roi_map = all.sort((a, b) => a.t - b.t);
            }
            info.stoploss = getNum(/stoploss\s*=\s*([-\d.]+)/);
            info.trailing_stop = getBool(/trailing_stop\s*=\s*(True|False)/i);
            info.trailing_stop_positive = getNum(/trailing_stop_positive\s*=\s*([\d.]+)/i);
            info.trailing_stop_positive_offset = getNum(/trailing_stop_positive_offset\s*=\s*([\d.]+)/i);
            info.trailing_only_offset_is_reached = getBool(/trailing_only_offset_is_reached\s*=\s*(True|False)/i);
            info.can_short = getBool(/can_short\s*=\s*(True|False)/i);
            const proc = getBool(/process_only_new_candles\s*=\s*(True|False)/i);
            if (proc !== null) info.process_only_new_candles = proc;
            const sc = code.match(/startup_candle_count\s*:\s*int\s*=\s*(\d+)/);
            if (sc) info.startup_candle_count = parseInt(sc[1], 10);
            info.interface_version = getInt(/INTERFACE_VERSION\s*=\s*(\d+)/);
            return info;
        }

        async function loadStrategyDetail(name) {
            const box = document.getElementById('strategy-detail');
            if (box) { box.style.display = 'block'; box.innerHTML = '<div>Loading strategy...</div>'; }
            try {
                const data = await getStrategyDetail(name);
                renderStrategyDetail(data);
            } catch (e) {
                if (box) box.innerHTML = `<div>Failed to load strategy: ${e.message || 'Unknown error'}</div>`;
                console.error('Failed to fetch strategy detail:', e);
            }
        }

        function renderStrategyDetail(payload) {
            const box = document.getElementById('strategy-detail');
            if (!box) return;
            const root = Array.isArray(payload) ? payload[0] : payload;
            const info = parseStrategyInfo(root);
            const pill = (label, value) => `
                <div style="background:#f8f9fa; border-radius:10px; padding:10px 12px;">
                    <div style="font-size:12px; color:#667;">${label}</div>
                    <div style="font-weight:700; margin-top:4px;">${value}</div>
                </div>`;
            const chip = (text) => `<span style="display:inline-block; background:#eef2ff; color:#4a57d0; border-radius:999px; padding:4px 8px; font-size:12px; font-weight:600; margin:2px;">${text}</span>`;
            const yesno = (v) => v === null ? '-' : (v ? 'Yes' : 'No');
            const roiText = info.minimal_roi ? `${info.minimal_roi.value} (t=${info.minimal_roi.t})` : '-';
            const header = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                    <div class="trade-icon icon"></div>
                    <div style="font-weight:700; font-size:16px; color:#2c3e50;">${info.name}</div>
                    <div style="margin-left:auto; color:#667; font-size:12px;">Timeframe: ${info.timeframe}</div>
                </div>`;
            const roiChips = info.minimal_roi_map.length
                ? info.minimal_roi_map.map(r => chip(`${r.value} (t=${r.t})`)).join('')
                : chip(roiText);
            const trailingDetails = info.trailing_stop ?
                `Enabled · Pos: ${info.trailing_stop_positive ?? '-'} · Offset: ${info.trailing_stop_positive_offset ?? '-'} · OnlyOffReached: ${yesno(info.trailing_only_offset_is_reached)}`
                : 'No';
            const grid = `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                    ${pill('Entry', `Timeframe ${info.timeframe} · New candles only: ${yesno(info.process_only_new_candles)}`)}
                    ${pill('Take Profit (ROI)', `<div>${roiChips}</div>`)}
                    ${pill('Stoploss', info.stoploss !== null ? info.stoploss : '-')}
                    ${pill('Trailing Stop', trailingDetails)}
                    ${pill('Can Short', yesno(info.can_short))}
                    ${pill('Startup Candles', info.startup_candle_count !== null ? info.startup_candle_count : '-')}
                    ${pill('Interface Version', info.interface_version !== null ? info.interface_version : '-')}
                </div>`;
            box.innerHTML = header + grid;
        }

        // ===== Control Bot: Status from /health and runmode from /show_config =====
        async function getHealth() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/health';
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        async function getConfigRunmode() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/show_config';
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        function fmtDuration(seconds) {
            if (seconds == null || !isFinite(seconds)) return '—';
            const d = Math.floor(seconds / 86400);
            seconds %= 86400;
            const h = Math.floor(seconds / 3600);
            seconds %= 3600;
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            const parts = [];
            if (d) parts.push(`${d}d`);
            if (h) parts.push(`${h}h`);
            if (m) parts.push(`${m}m`);
            if (!parts.length) parts.push(`${s}s`);
            return parts.join(' ');
        }

        async function refreshBotStatus() {
            const dot = document.getElementById('bot-status-dot');
            const txt = document.getElementById('bot-status-text');
            const run = document.getElementById('bot-runmode');
            const up = document.getElementById('bot-uptime');
            const last = document.getElementById('bot-last-action');
            try {
                const [health, config] = await Promise.all([getHealth(), getConfigRunmode()]);
                const h = Array.isArray(health) ? health[0] : health;
                const c = Array.isArray(config) ? config[0] : config;
                const nowTs = Math.floor(Date.now() / 1000);
                const lastTs = Number(h?.last_process_ts);
                const startTs = Number(h?.bot_start_ts);
                const uptimeSec = startTs ? Math.max(0, nowTs - startTs) : null;
                // Determine running if last_process is within last 60s
                const isRunning = lastTs && (nowTs - lastTs) <= 60;
                if (dot) dot.style.background = isRunning ? '#4caf50' : '#ff5252';
                if (txt) txt.textContent = isRunning ? 'Running' : 'Stopped';
                if (run) run.textContent = c?.runmode === 'live' ? 'Live Mode' : 'Dry Run';
                if (up) up.textContent = fmtDuration(uptimeSec);
                if (last) last.textContent = h?.last_process ? new Date(h.last_process).toLocaleString() : '—';
            } catch (e) {
                console.error('Failed to refresh bot status:', e);
                if (dot) dot.style.background = '#ccc';
                if (txt) txt.textContent = 'Unknown';
            }
        }

        // ===== Control Bot: Action handlers (POST) with toast feedback =====
        function showToast(message, type = 'info') {
            // Create container if not exists
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.position = 'fixed';
                container.style.top = '16px';
                container.style.right = '16px';
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.gap = '8px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.style.minWidth = '220px';
            toast.style.maxWidth = '360px';
            toast.style.padding = '10px 12px';
            toast.style.borderRadius = '10px';
            toast.style.color = '#fff';
            toast.style.boxShadow = '0 8px 18px rgba(0,0,0,0.2)';
            toast.style.fontSize = '13px';
            toast.style.fontWeight = '600';
            toast.style.background = type === 'success' ? 'linear-gradient(135deg,#2e7d32,#1b5e20)'
                : type === 'error' ? 'linear-gradient(135deg,#d32f2f,#b71c1c)'
                    : 'linear-gradient(135deg,#1976d2,#0d47a1)';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.transition = 'opacity .3s ease, transform .3s ease';
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-6px)';
                setTimeout(() => toast.remove(), 350);
            }, 2000);
        }

        async function postAction(name, url) {
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ source: 'dashboard' })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                showToast(`${name} successful`, 'success');
                if (typeof refreshBotStatus === 'function') refreshBotStatus();
            } catch (e) {
                console.error(`${name} failed:`, e);
                showToast(`${name} failed`, 'error');
            }
        }

        function startBot() { postAction('Start Bot', 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/start'); }
        function stopBot() { postAction('Stop Bot', 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/stop'); }
        function reloadBotConfig() { postAction('Reload Config', 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/reload_config'); }
        function stopBuy() { postAction('Stop Buy', 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/stopbuy'); }
        function stopEntry() { postAction('Stop Entry', 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/stopentry'); }
        function pauseBot() { postAction('Pause Bot', 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/pause'); }

        // ===== Circle Progress using exit_reasons.force_exit (wins/losses/draws) =====
        function extractCountsFromStats(payload) {
            const root = Array.isArray(payload) ? payload[0] : payload;
            const er = root?.exit_reasons?.force_exit || {};
            const wins = Number(er.wins || 0);
            const losses = Number(er.losses || 0);
            const draws = Number(er.draws || 0);
            return { wins, losses, draws };
        }

        function setCircleProgressForSuffix(counts, suffix = '') {
            const total = Math.max(0, (counts.wins || 0) + (counts.losses || 0) + (counts.draws || 0));
            const C = 565; // circumference used in SVG
            const ids = (id) => suffix ? `${id}-${suffix}` : id;
            // Numbers
            const totalEl = document.getElementById(ids('total-trades-number'));
            const wEl = document.getElementById(ids('wins-count'));
            const lEl = document.getElementById(ids('losses-count'));
            const dEl = document.getElementById(ids('draws-count'));
            if (totalEl) totalEl.textContent = String(total);
            if (wEl) wEl.textContent = String(counts.wins || 0);
            if (lEl) lEl.textContent = String(counts.losses || 0);
            if (dEl) dEl.textContent = String(counts.draws || 0);
            // Arcs
            const winArc = document.getElementById(ids('wins-arc'));
            const lossArc = document.getElementById(ids('losses-arc'));
            const drawArc = document.getElementById(ids('draws-arc'));
            const winOff = total ? C - (C * (counts.wins / total)) : C;
            const lossOff = total ? C - (C * (counts.losses / total)) : C;
            const drawOff = total ? C - (C * (counts.draws / total)) : C;
            if (winArc) winArc.setAttribute('stroke-dashoffset', String(winOff));
            if (lossArc) lossArc.setAttribute('stroke-dashoffset', String(lossOff));
            if (drawArc) drawArc.setAttribute('stroke-dashoffset', String(drawOff));
        }

        async function refreshStatsCircles() {
            try {
                const stats = await getTradeStats();
                const counts = extractCountsFromStats(stats);
                // Dashboard circles (no suffix)
                setCircleProgressForSuffix(counts, '');
                // Trades page circles use suffix '2' (ids like wins-arc-2)
                setCircleProgressForSuffix(counts, '2');
            } catch (e) {
                // Silently ignore; circles will keep prior values
                console.debug('refreshStatsCircles failed:', e);
            }
        }

        // Periodic refresh for live overview, trades/count/stats and circle progress
        setInterval(() => {
            fetchOverview();
            fetchTradesAndStats();
            refreshStatsCircles();
        }, 1000);

        // ===== Closed Trades (fetch once on open) =====
        async function getClosedTrades() {
            const url = 'https://involving-attacked-prostate-usage.trycloudflare.com/api/v1/trades';
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('freqtrader:ravi'),
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        function humanDurationSec(totalSeconds) {
            if (totalSeconds == null || !isFinite(totalSeconds)) return '-';
            const s = Math.max(0, Math.floor(totalSeconds));
            const d = Math.floor(s / 86400);
            const h = Math.floor((s % 86400) / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            if (d) return `${d}d ${h}h ${m}m`;
            if (h) return `${h}h ${m}m`;
            if (m) return `${m}m ${sec}s`;
            return `${sec}s`;
        }

        function normalizePair(p) {
            // Remove futures/accounting suffix after ':' e.g., 'SUPER/USDT:USDT' -> 'SUPER/USDT'
            return (typeof p === 'string') ? p.replace(/:.+$/, '') : p;
        }

        function formatDateTimeIST(epochMs) {
            if (!epochMs) return '-';
            try {
                const dtf = new Intl.DateTimeFormat('en-GB', {
                    timeZone: 'Asia/Kolkata',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', hour12: true
                });
                const parts = dtf.formatToParts(new Date(epochMs));
                const get = (t) => parts.find(p => p.type === t)?.value || '';
                const y = get('year');
                const m = get('month');
                const d = get('day');
                const hh = get('hour');
                const mm = get('minute');
                // Some browsers return dayPeriod as 'AM'/'PM'
                const ap = (parts.find(p => p.type === 'dayPeriod')?.value || '').toLowerCase();
                // Desired: 02:03 pm | 08/09/2025
                return `${hh}:${mm} ${ap} | ${d}/${m}/${y}`;
            } catch {
                return '-';
            }
        }

        function renderClosedTrades(payload) {
            const root = Array.isArray(payload) ? payload[0] : payload;
            const list = Array.isArray(root?.trades) ? root.trades : [];
            const closed = list.filter(t => t.is_open === false);
            const tbody = document.getElementById('trades-list-closed');
            const summary = document.getElementById('trade-summary-closed');
            if (!tbody) return;
            const rowsHtml = closed.map(t => {
                const pair = normalizePair(t.pair || '-');
                const amount = (typeof t.amount !== 'undefined') ? t.amount : '-';
                const openRate = (typeof t.open_rate !== 'undefined') ? t.open_rate : '-';
                const closeRate = (typeof t.close_rate !== 'undefined') ? t.close_rate : '-';
                const profitRatio = (typeof t.profit_ratio === 'number') ? (t.profit_ratio * 100).toFixed(2) + '%' : (typeof t.close_profit_pct === 'number' ? t.close_profit_pct.toFixed(2) + '%' : '-');
                const pnl = (typeof t.profit_abs === 'number') ? t.profit_abs : (typeof t.close_profit_abs === 'number' ? t.close_profit_abs : (typeof t.realized_profit === 'number' ? t.realized_profit : '-'));
                const pos = t.is_short ? 'Short' : 'Long';
                const durSec = (typeof t.trade_duration_s === 'number') ? t.trade_duration_s : (typeof t.open_timestamp === 'number' && typeof t.close_timestamp === 'number' ? Math.floor((t.close_timestamp - t.open_timestamp) / 1000) : null);
                const duration = humanDurationSec(durSec);
                const totalFee = ((t.fee_open_cost || 0) + (t.fee_close_cost || 0) + (t.funding_fees || 0)).toFixed(6);
                const time = t.close_timestamp ? formatDateTimeIST(t.close_timestamp) : (t.close_date || '-');
                const pnlColor = (typeof pnl === 'number' && pnl >= 0) ? '#2e7d32' : '#d32f2f';
                return `
                    <tr>
                        <td data-label="Pair"><div class="trade-pair"><div class="trade-icon icon"></div><span>${pair}</span></div></td>
                        <td data-label="Amount">${amount}</td>
                        <td data-label="Open Rate">${openRate}</td>
                        <td data-label="Close Rate">${closeRate}</td>
                        <td data-label="Profit Ratio">${profitRatio}</td>
                        <td data-label="PNL" style="color:${pnlColor}">${typeof pnl === 'number' ? pnl.toFixed(6) : pnl}</td>
                        <td data-label="Position">${pos}</td>
                        <td data-label="Duration">${duration}</td>
                        <td data-label="Total Fee">${totalFee}</td>
                        <td data-label="Time">${time}</td>
                    </tr>`;
            }).join('');
            tbody.innerHTML = rowsHtml || '<tr><td colspan="10">No closed trades.</td></tr>';
            if (summary) {
                const total = closed.length;
                const totalPnl = closed.reduce((acc, t) => acc + (Number(t.profit_abs ?? t.close_profit_abs ?? t.realized_profit) || 0), 0);
                summary.innerHTML = `
                    <span class="badge blue"><span class="dot"></span> Closed: ${total}</span>
                    <span class="badge ${totalPnl >= 0 ? 'green' : 'orange'}"><span class="dot"></span> PnL: ${totalPnl.toFixed(4)}</span>
                `;
            }
        }

        async function loadClosedTrades() {
            const tbody = document.getElementById('trades-list-closed');
            if (tbody) tbody.innerHTML = '<tr><td colspan="10">Loading closed trades...</td></tr>';
            try {
                const data = await getClosedTrades();
                renderClosedTrades(data);
            } catch (e) {
                console.error('Failed to load closed trades:', e);
                if (tbody) tbody.innerHTML = `<tr><td colspan="10">Failed to load closed trades: ${e.message || 'Unknown error'}</td></tr>`;
            }
        }

        // On initial load, fetch closed trades once (independent of active tab)
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.__closedTradesLoaded) {
                if (typeof loadClosedTrades === 'function') loadClosedTrades();
                window.__closedTradesLoaded = true;
            }
        });


    </script>
</body>

</html>
